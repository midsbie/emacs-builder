#!/usr/bin/env bash

#set -o xtrace
set -e

fatal() {
    echo "$@" >&2
    exit 1
}

usage() {
    echo "Usage: $0 [OPTIONS]"
    echo
    echo "Options:"
    echo "  --server    Build for server/headless environments (no X11, no DBus)"
    echo "  --help      Show this help message"
    exit 0
}

# Parse command line arguments
SERVER_BUILD=0
while [[ $# -gt 0 ]]; do
  case $1 in
    --server)
      SERVER_BUILD=1
      shift
      ;;
    --help|-h)
      usage
      ;;
    *)
      fatal "Unknown option: $1"
      ;;
  esac
done

# Check if host system can run X11 builds
can_build_x11() {
  dpkg -s libx11-6 &>/dev/null
}

cd $(cd $(dirname "$0") && pwd)

if [ "$(id -u)" -ne 0 ]; then
  ELEVATE="sudo"

  if ! command -v sudo &>/dev/null; then
    fatal "ERROR: sudo binary not found. Please install sudo."
  fi
else
  ELEVATE=""
fi

if ! command -v docker &>/dev/null; then
  fatal "ERROR: docker binary not found. Please install the Docker engine."
elif [ -f /.dockerenv ]; then
  fatal "ERROR: cannot run this script from within a Docker container."
elif ! docker ps &> /dev/null; then
  DOCKER="sudo docker"
else
  DOCKER="docker"
fi

if ! command -v make &>/dev/null; then
  fatal "ERROR: make command not found. Please install make."
fi

if [ "$SERVER_BUILD" -eq 1 ]; then
  TARGET_ENV=server
  BUILDER_SERVICE=builder-server
  echo "I: building for server/headless environment"
elif can_build_x11; then
  TARGET_ENV=x
  BUILDER_SERVICE=builder
  echo "I: X11 libraries detected, building with GUI support"
else
  TARGET_ENV=server
  BUILDER_SERVICE=builder-server
  echo "I: X11 libraries not found, building for server/headless environment"
fi

source ./env.sh
export TARGET_ENV

# Detect tree-sitter installation
# Priority: source installation (~/src/tree-sitter) > apt package
TREESITTER_VOLUMES=""
TREESITTER_SOURCE_DIR="${TREESITTER_SOURCE_DIR:-$HOME/src/tree-sitter}"

if [ -f "$TREESITTER_SOURCE_DIR/tree-sitter.pc" ]; then
  # Source installation detected via symlink/directory at ~/src/tree-sitter
  # Read prefix and version from tree-sitter.pc
  TS_PREFIX=$(grep "^prefix=" "$TREESITTER_SOURCE_DIR/tree-sitter.pc" | cut -d= -f2)
  TS_VERSION=$(grep "^Version:" "$TREESITTER_SOURCE_DIR/tree-sitter.pc" | cut -d: -f2 | tr -d ' ')
  TS_LIBDIR="${TS_PREFIX}/lib"
  TS_INCLUDEDIR="${TS_PREFIX}/include"

  if [ -d "$TS_LIBDIR" ] && [ -d "$TS_INCLUDEDIR" ]; then
    echo "I: using tree-sitter $TS_VERSION from source installation at $TS_PREFIX"
    TREESITTER_VOLUMES="--volume $TS_LIBDIR:/opt/tree-sitter/lib:ro --volume $TS_INCLUDEDIR:/opt/tree-sitter/include:ro"
    export TREESITTER_SOURCE=1
    export TREESITTER_VERSION="$TS_VERSION"
  else
    echo "W: tree-sitter.pc found but libraries not at $TS_LIBDIR - falling back to apt package"
  fi
elif dpkg -s libtree-sitter0 &>/dev/null; then
  echo "I: using tree-sitter from apt package (libtree-sitter0)"
else
  echo "W: no tree-sitter installation detected - build may fail"
fi

$DOCKER compose --progress plain \
        run \
        --volume $(pwd):$(pwd) \
        --workdir $(pwd) \
        $TREESITTER_VOLUMES \
        $BUILDER_SERVICE

( cd emacs && $ELEVATE make install )

echo "done."
